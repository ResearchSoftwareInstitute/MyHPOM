{% extends 'myhpom/includes/upload_base.html' %}

{% block widget_breadcrumb_items %}
    <li class="advance-directive-widget__breadcrumb-item breadcrumb-item--selected">
        Select Document
    </li>
    <li class="advance-directive-widget__breadcrumb-item">
        Submit
    </li>
    <li class="advance-directive-widget__breadcrumb-item">
        Confirmation
    </li>
{% endblock widget_breadcrumb_items %}

{% block widget_body %}
	<div class="upload-requirements__div">
		<h3 class="h6">ADVANCE DIRECTIVE DOCUMENT REQUIREMENTS FOR {{ user.userdetails.state.title|upper }}</h3>
		<ol class="upload-requirements__ol">
			{% for requirement in requirements %}
			<li class="upload-requirements__li">
				<input class="upload-requirements__checkbox" type="checkbox" id="id_requirement_{{ requirement.id }}" class="upload-requirements__checkbox"/>
				<label class="upload-requirements__label" for="id_requirement_{{ requirement.id }}">{{ requirement.text }}</label>
				<ol class="upload-requirements-link__ol">
					{% for link in requirement.staterequirementlink_set.all %}
					<li class="upload-requirements-link__li">
						<a href="{{ link.href }}" onClick="event.preventDefault();">{{ link.text }}</a>
					</li>
					{% endfor %}
				</ol>
			</li>
			{% endfor %}
		</ol>
	</div>

	<div class="upload-requirements__div">
		<h4 class="upload-requirements__h4">My file is valid starting:
			<a class="upload-requirements__a--right" href="" onClick="event.preventDefault();">What is this?</a>
		</h4>
		<form id="id_requirements__form" class="upload-requirements__form" method="POST">
			{% csrf_token %}
			<div id="id_valid_date_div" class="upload-requirements__input-div{% if form.errors.valid_date %}--invalid{% endif %}">
				<input id="id_valid_date" name="valid_date" data-min-year="{{ MIN_YEAR }}" data-max-year="{{ MAX_YEAR }}"{% if form.errors.valid_date %} class="upload-requirement__input--invalid"{% endif %}/>
			</div>
			<div id="id_valid_date_errors" class="upload-requirements__div-errors">
				{{ form.errors.valid_date }}
			</div>
		</form>
	</div>

	<div class="upload-requirements__div">
		<ol class="upload-requirements__ol">
			<li class="upload-requirements__li">
				<input type="checkbox" id="id_approval_checkbox" class="upload-requirements__checkbox"/>
				<label class="upload-requirements__label" for="id_approval_checkbox">I approve this file for storage</label>
				<ol class="upload-requirements-link__ol">
					<li class="upload-requirements-link__li">
						<a href="" onClick="event.preventDefault();">Review Terms and Conditions</a>
					</li>
				</ol>
			</li>
		</ol>
	</div>

	<div class="upload-requirements__div">
		<button type="button" class="btn btn-primary" id="id_button_select_file">
			SELECT FILE
		</button>
	</div>

	<div class="upload-requirements__div">
		<a href="{% url 'myhpom:dashboard' %}">CANCEL</a>
	</div>

<script>
    jQuery(function ($) {
        var $requirements = $('.upload-requirements__checkbox');
        var $selectFileButton = $('#id_button_select_file');
        var $directiveDateInput = $('#id_valid_date');

		function selectFileEnableDisable () {
			if ($('.upload-requirements__checkbox:checked').length == $requirements.length
				&& $directiveDateInput.combodate('getValue') != ''
			) {
	    		$selectFileButton.prop('disabled', null);
	    	} else {
	    		$selectFileButton.prop('disabled', 'disabled');
	    	}
		}

        $requirements.on('change', function (event) {
        	selectFileEnableDisable();
        });

        $requirements.trigger('change');

	    $directiveDateInput.combodate({
		    smartDays: true,
		    format: "YYYY-MM-DD",
		    template: "MMMM D YYYY"
		});

	    var NOW = new Date();
	    var WAS_VALID = false;
		$directiveDateInput.on('change', function (event) {
			if ($directiveDateInput.combodate('getValue')=='') {
				$("#id_valid_date_div select").addClass("upload-requirement__select--invalid");
				if (WAS_VALID==true) {
					$("#id_valid_date_errors").html("Please enter the valid date of your document.");
				}
			} else {
				var NOW = new Date();
				var $directiveDate = new Date($directiveDateInput.val() + " 00:00:00");
				if ($directiveDate > NOW) {
					$("#id_valid_date_div select").addClass("upload-requirement__select--invalid");
					$("#id_valid_date_errors").html("Please enter a valid date on or before today.");	
				} else {
					$("#id_valid_date_div select").removeClass("upload-requirement__select--invalid");
					$("#id_valid_date_errors").html("");
					WAS_VALID = true;
				}
			}
			selectFileEnableDisable();
		});

		$selectFileButton.on('click', function (event) {
			$('#id_requirements__form').submit();
		});
    });
</script>
{% endblock widget_body %}